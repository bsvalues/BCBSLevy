{% extends "base.html" %}

{% block title %}Levy Calculator - Benton County Levy Calculator{% endblock %}

{% block page_title %}Enhanced Levy Rate Calculator{% endblock %}
{% block page_subtitle %}Calculate levy rates, apply statutory limits, perform scenario analysis and view historical comparisons{% endblock %}

{% block head %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-12 mx-auto">
        {% if calculated %}
        <!-- Calculation Results -->
        <div class="card border-success mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-check-circle me-2"></i> Levy Rates Calculated Successfully</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-light mb-4">
                    <p class="mb-0">
                        The levy rates have been calculated and stored in the database. You can now view the calculated rates
                        in the table below or use them for property tax calculations.
                    </p>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Tax Code</th>
                                <th>Original Rate</th>
                                <th>Limited Rate</th>
                                <th>Change</th>
                                <th>Limits Applied</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for tax_code in tax_codes %}
                            {% if tax_code.levy_rate %}
                            <tr>
                                <td>{{ tax_code.code }}</td>
                                <td>
                                    {% if levy_rates and tax_code.code in levy_rates %}
                                    {{ '%0.4f'|format(levy_rates[tax_code.code]|float) }}
                                    {% else %}
                                    <span class="text-muted">--</span>
                                    {% endif %}
                                </td>
                                <td>{{ '%0.4f'|format(tax_code.levy_rate|float) }}</td>
                                <td>
                                    {% if levy_rates and tax_code.code in levy_rates %}
                                    {% set diff = tax_code.levy_rate - levy_rates[tax_code.code] %}
                                    {% if diff < 0 %}
                                    <span class="text-danger">{{ '%0.4f'|format(diff|float) }}</span>
                                    {% else %}
                                    <span class="text-success">+{{ '%0.4f'|format(diff|float) }}</span>
                                    {% endif %}
                                    {% else %}
                                    <span class="text-muted">--</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if limited_rates and tax_code.code in limited_rates %}
                                    {% if limited_rates[tax_code.code] != levy_rates[tax_code.code] %}
                                    <span class="badge bg-warning text-dark">Statutory Limits Applied</span>
                                    {% else %}
                                    <span class="badge bg-success">Within Limits</span>
                                    {% endif %}
                                    {% else %}
                                    <span class="text-muted">--</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                    <a href="{{ url_for('reports') }}" class="btn btn-outline-primary">
                        <i class="bi bi-file-earmark-excel me-2"></i> Generate Reports
                    </a>
                    <a href="{{ url_for('property_lookup') }}" class="btn btn-outline-primary">
                        <i class="bi bi-search me-2"></i> Property Lookup
                    </a>
                </div>
            </div>
        </div>
        
        <!-- MCP Insights - AI Analysis -->
        {% if mcp_insights %}
        <div class="mb-4">
            {{ mcp_insights.narrative|safe }}
        </div>
        {% endif %}
        
        <!-- Historical Comparison Chart -->
        {% if historical_comparison %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i> Historical Rate Comparison</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <p class="mb-0">Compare current levy rates to previous year rates to see changes and trends.</p>
                </div>
                
                <div style="height: 300px">
                    <canvas id="historicalChart"></canvas>
                </div>
                
                <div class="table-responsive mt-4">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Tax Code</th>
                                <th>Current Rate</th>
                                <th>Previous Rate</th>
                                <th>Change (%)</th>
                                <th>Direction</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in historical_comparison %}
                            <tr>
                                <td>{{ item.code }}</td>
                                <td>{{ '%0.4f'|format(item.current_rate|float) }}</td>
                                <td>{{ '%0.4f'|format(item.previous_rate|float) }}</td>
                                <td>
                                    {% if item.change_pct > 0 %}
                                    <span class="text-success">+{{ '%0.2f'|format(item.change_pct|float) }}%</span>
                                    {% elif item.change_pct < 0 %}
                                    <span class="text-danger">{{ '%0.2f'|format(item.change_pct|float) }}%</span>
                                    {% else %}
                                    <span class="text-muted">0.00%</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.direction == 'increase' %}
                                    <span class="badge bg-success">Increase</span>
                                    {% elif item.direction == 'decrease' %}
                                    <span class="badge bg-danger">Decrease</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Unchanged</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Levy Scenario Analysis -->
        {% if scenario_results %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i> Levy Scenario Analysis</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <p class="mb-0">This analysis shows the impact of different levy scenarios on rates and statutory limits.</p>
                </div>
                
                <div style="height: 300px">
                    <canvas id="scenarioChart"></canvas>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Original vs. Limited Rates</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Scenario</th>
                                                <th>Original Rate (Avg)</th>
                                                <th>Limited Rate (Avg)</th>
                                                <th>% Limited</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for scenario in scenario_results %}
                                            <tr>
                                                <td>{{ scenario.name }}</td>
                                                <td>
                                                    {% set total_orig = 0 %}
                                                    {% set count_orig = 0 %}
                                                    {% for code, data in scenario.scenarios.items() %}
                                                        {% if data.rate %}
                                                            {% set total_orig = total_orig + data.rate %}
                                                            {% set count_orig = count_orig + 1 %}
                                                        {% endif %}
                                                    {% endfor %}
                                                    {% if count_orig > 0 %}
                                                        {{ '%0.4f'|format(total_orig / count_orig) }}
                                                    {% else %}
                                                        <span class="text-muted">--</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% set total_lim = 0 %}
                                                    {% set count_lim = 0 %}
                                                    {% for code, data in scenario.scenarios.items() %}
                                                        {% if data.limited_rate %}
                                                            {% set total_lim = total_lim + data.limited_rate %}
                                                            {% set count_lim = count_lim + 1 %}
                                                        {% endif %}
                                                    {% endfor %}
                                                    {% if count_lim > 0 %}
                                                        {{ '%0.4f'|format(total_lim / count_lim) }}
                                                    {% else %}
                                                        <span class="text-muted">--</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% set limited_count = 0 %}
                                                    {% for code, data in scenario.scenarios.items() %}
                                                        {% if data.limited %}
                                                            {% set limited_count = limited_count + 1 %}
                                                        {% endif %}
                                                    {% endfor %}
                                                    {% if count_orig > 0 %}
                                                        {{ '%0.1f'|format((limited_count / count_orig) * 100) }}%
                                                    {% else %}
                                                        <span class="text-muted">--</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Impact Analysis</h6>
                            </div>
                            <div class="card-body">
                                <p>Impact of scenarios on an average property with assessed value of $300,000:</p>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Scenario</th>
                                                <th>Tax Amount</th>
                                                <th>Change</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% set baseline = 0 %}
                                            {% for scenario in scenario_results %}
                                                {% set avg_rate = 0 %}
                                                {% set count = 0 %}
                                                {% for code, data in scenario.scenarios.items() %}
                                                    {% if data.limited_rate %}
                                                        {% set avg_rate = avg_rate + data.limited_rate %}
                                                        {% set count = count + 1 %}
                                                    {% endif %}
                                                {% endfor %}
                                                {% if count > 0 %}
                                                    {% set avg_rate = avg_rate / count %}
                                                    {% set tax = (300000 / 1000) * avg_rate %}
                                                    {% if loop.first %}
                                                        {% set baseline = tax %}
                                                    {% endif %}
                                                    <tr>
                                                        <td>{{ scenario.name }}</td>
                                                        <td>${{ '%0.2f'|format(tax) }}</td>
                                                        <td>
                                                            {% set diff = tax - baseline %}
                                                            {% if diff > 0 %}
                                                                <span class="text-danger">+${{ '%0.2f'|format(diff) }}</span>
                                                            {% elif diff < 0 %}
                                                                <span class="text-success">-${{ '%0.2f'|format(diff|abs) }}</span>
                                                            {% else %}
                                                                <span class="text-muted">$0.00</span>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        {% endif %}
        
        <!-- Levy Calculator Form -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-calculator me-2"></i> Enter Levy Amounts</h5>
            </div>
            <div class="card-body">
                {% if tax_codes %}
                <form action="{{ url_for('levy_calculator') }}" method="post">
                    <div class="alert alert-info mb-4">
                        <h6 class="mb-2"><i class="bi bi-info-circle me-2"></i>Levy Calculation Information</h6>
                        <p class="mb-0">
                            Enter the levy amount (in dollars) for each tax code area. The system will calculate the
                            levy rate per $1,000 of assessed value and apply statutory limits:
                            <ul class="mb-0">
                                <li>101% cap: Rate cannot exceed 101% of previous year's rate</li>
                                <li>$5.90 per $1,000 maximum rate cap</li>
                            </ul>
                        </p>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover table-levy">
                            <thead>
                                <tr>
                                    <th>Tax Code</th>
                                    <th>Total Assessed Value</th>
                                    <th>Previous Rate</th>
                                    <th>Enter Levy Amount ($)</th>
                                    <th>Calculated Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tax_code in tax_codes %}
                                <tr>
                                    <td>{{ tax_code.code }}</td>
                                    <td>${{ '%0.2f'|format(tax_code.total_assessed_value|float) }}</td>
                                    <td>
                                        {% if tax_code.previous_year_rate %}
                                        {{ '%0.4f'|format(tax_code.previous_year_rate|float) }}
                                        {% else %}
                                        <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" class="form-control" 
                                                   name="levy_amount_{{ tax_code.code }}" 
                                                   value="{{ tax_code.levy_amount|float if tax_code.levy_amount else '' }}"
                                                   step="0.01" min="0">
                                        </div>
                                    </td>
                                    <td>
                                        {% if tax_code.levy_rate %}
                                        {{ '%0.4f'|format(tax_code.levy_rate|float) }}
                                        {% else %}
                                        <span class="text-muted">Not calculated</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-calculator me-2"></i> Calculate Levy Rates
                        </button>
                    </div>
                </form>
                {% else %}
                <div class="alert alert-warning">
                    <h6><i class="bi bi-exclamation-triangle me-2"></i>No Tax Codes Available</h6>
                    <p class="mb-0">
                        No tax code areas were found in the database. Please import property data first
                        to create tax code areas.
                    </p>
                </div>
                <div class="d-grid gap-2 col-6 mx-auto mt-4">
                    <a href="{{ url_for('import_data') }}" class="btn btn-primary">
                        <i class="bi bi-file-earmark-arrow-up me-2"></i> Import Property Data
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Historical Levy Rate Comparison -->
        {% if historical_comparison %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i> Historical Levy Rate Comparison</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Tax Code</th>
                                <th>Current Rate</th>
                                <th>Previous Rate</th>
                                <th>Change (%)</th>
                                <th>Direction</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in historical_comparison %}
                            <tr>
                                <td>{{ item.code }}</td>
                                <td>{{ '%0.4f'|format(item.current_rate|float) }}</td>
                                <td>{{ '%0.4f'|format(item.previous_rate|float) }}</td>
                                <td>
                                    {% if item.change_pct > 0 %}
                                    <span class="text-success">+{{ '%0.2f'|format(item.change_pct|float) }}%</span>
                                    {% elif item.change_pct < 0 %}
                                    <span class="text-danger">{{ '%0.2f'|format(item.change_pct|float) }}%</span>
                                    {% else %}
                                    <span class="text-muted">0.00%</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.direction == 'increase' %}
                                    <span class="badge bg-success">Increase</span>
                                    {% elif item.direction == 'decrease' %}
                                    <span class="badge bg-danger">Decrease</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Unchanged</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-shield-lock me-2"></i> Statutory Limits Explained</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">101% Cap</h5>
                                <p class="card-text">
                                    The levy rate cannot exceed 101% of the previous year's rate.
                                    This limit is applied as:
                                </p>
                                <pre class="bg-dark text-light p-2 rounded"><code>max_rate = previous_year_rate * 1.01</code></pre>
                                <p class="card-text mt-2">
                                    If a previous year's rate is not available, this limit is not applied.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">$5.90 Maximum Rate</h5>
                                <p class="card-text">
                                    The levy rate cannot exceed $5.90 per $1,000 of assessed value.
                                    This is an absolute maximum limit.
                                </p>
                                <pre class="bg-dark text-light p-2 rounded"><code>if calculated_rate > 5.90:
    calculated_rate = 5.90</code></pre>
                                <p class="card-text mt-2">
                                    This limit is always applied, regardless of previous year's rate.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-secondary mt-4">
                    <h6 class="mb-2">How Levy Rates Are Calculated</h6>
                    <p class="mb-0">
                        The levy rate is calculated by dividing the levy amount by the total assessed value of all
                        properties in the tax code area, then multiplying by 1,000 to get the rate per $1,000 of
                        assessed value:
                    </p>
                    <pre class="bg-dark text-light p-2 rounded my-2"><code>levy_rate = (levy_amount / total_assessed_value) * 1000</code></pre>
                    <p class="mb-0">
                        After calculation, statutory limits are applied to ensure compliance with legal requirements.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block mcp_insights %}
{% include 'partials/mcp_insights.html' %}
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Add JavaScript for the historical comparison chart -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize historical comparison chart if data and canvas exist
    var historicalChartCanvas = document.getElementById('historicalChart');
    {% if historical_comparison %}
    if (historicalChartCanvas) {
        var taxCodes = [{% for item in historical_comparison %}'{{ item.code }}',{% endfor %}];
        var currentRates = [{% for item in historical_comparison %}{{ item.current_rate|float }},{% endfor %}];
        var previousRates = [{% for item in historical_comparison %}{{ item.previous_rate|float }},{% endfor %}];
        
        new Chart(historicalChartCanvas, {
            type: 'bar',
            data: {
                labels: taxCodes,
                datasets: [
                    {
                        label: 'Current Rate',
                        data: currentRates,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Previous Rate',
                        data: previousRates,
                        backgroundColor: 'rgba(153, 102, 255, 0.6)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Levy Rate (per $1,000)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Tax Code'
                        }
                    }
                }
            }
        });
    }
    {% endif %}
    
    // Initialize scenario analysis chart if data and canvas exist
    var scenarioChartCanvas = document.getElementById('scenarioChart');
    {% if scenario_results %}
    if (scenarioChartCanvas) {
        var scenarios = [{% for scenario in scenario_results %}'{{ scenario.name }}',{% endfor %}];
        var scenarioData = [];
        
        {% for scenario in scenario_results %}
        // Calculate average rate for each scenario
        var totalRate = 0;
        var rateCount = 0;
        {% for code, data in scenario.scenarios.items() %}
        {% if data.limited_rate %}
        totalRate += {{ data.limited_rate|float }};
        rateCount++;
        {% endif %}
        {% endfor %}
        
        if (rateCount > 0) {
            scenarioData.push(totalRate / rateCount);
        } else {
            scenarioData.push(0);
        }
        {% endfor %}
        
        new Chart(scenarioChartCanvas, {
            type: 'line',
            data: {
                labels: scenarios,
                datasets: [
                    {
                        label: 'Average Levy Rate',
                        data: scenarioData,
                        backgroundColor: 'rgba(255, 159, 64, 0.2)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Levy Rate (per $1,000)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Scenario'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                var label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += context.parsed.y.toFixed(4);
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }
    {% endif %}
});
</script>
{% endblock %}
