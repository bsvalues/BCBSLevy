{% extends "base.html" %}

{% block title %}MCP Army Dashboard{% endblock %}

{% block head %}
{{ super() }}
<style>
  .agent-card {
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    transition: transform 0.2s;
  }
  
  .agent-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  }
  
  .agent-card .card-header {
    border-bottom: 1px solid rgba(0,0,0,0.1);
    font-weight: bold;
  }
  
  .status-initialized { color: #17a2b8; }
  .status-active { color: #28a745; }
  .status-idle { color: #6c757d; }
  .status-error { color: #dc3545; }
  
  .performance-indicator {
    width: 100%;
    height: 10px;
    background: #e9ecef;
    border-radius: 5px;
    overflow: hidden;
  }
  
  .performance-bar {
    height: 100%;
    background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
  }
  
  .metrics-card {
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }
  
  .experiences-table th, .experiences-table td {
    padding: 0.5rem;
    font-size: 0.875rem;
  }
  
  .help-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #dc3545;
    color: white;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  #communication-graph {
    width: 100%;
    height: 400px;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-top: 20px;
  }
  
  /* Notification system styles */
  .notification-card {
    border-left: 4px solid #007bff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
    margin-bottom: 10px;
  }
  
  .notification-card:hover {
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }
  
  .notification-card .badge.bg-success {
    background-color: #28a745 !important;
  }
  
  .notification-card .badge.bg-info {
    background-color: #17a2b8 !important;
  }
  
  .notification-card .badge.bg-warning {
    background-color: #ffc107 !important;
    color: #212529;
  }
  
  .notification-card .badge.bg-primary {
    background-color: #007bff !important;
  }
  
  .notification-card .badge.bg-secondary {
    background-color: #6c757d !important;
  }
  
  /* Activity feed scrollable area */
  #activity-feed {
    max-height: 400px;
    overflow-y: auto;
    padding-right: 5px;
  }
  
  /* Toast notification styles */
  .toast {
    background-color: #fff;
    border-radius: 0.5rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
  }
  
  .toast.show {
    opacity: 1;
  }
  
  .toast-header {
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  }
  
  .toast-success .toast-header {
    background-color: rgba(40, 167, 69, 0.1);
    color: #28a745;
  }
  
  .toast-info .toast-header {
    background-color: rgba(23, 162, 184, 0.1);
    color: #17a2b8;
  }
  
  .toast-warning .toast-header {
    background-color: rgba(255, 193, 7, 0.1);
    color: #856404;
  }
  
  .toast-error .toast-header {
    background-color: rgba(220, 53, 69, 0.1);
    color: #dc3545;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-12">
      <h1 class="display-4">MCP Army Dashboard</h1>
      <p class="lead">Monitoring and managing the Agent Army</p>
    </div>
  </div>
  
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card bg-primary text-white">
        <div class="card-body">
          <h5 class="card-title">Total Agents</h5>
          <h2 class="display-4">{{ agents|length }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-success text-white">
        <div class="card-body">
          <h5 class="card-title">Active Agents</h5>
          <h2 class="display-4">{{ agents|selectattr('status', 'equalto', 'active')|list|length }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-info text-white">
        <div class="card-body">
          <h5 class="card-title">Help Requests</h5>
          <h2 class="display-4" id="help-request-count">0</h2>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row">
    <div class="col-md-8">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Agent Status</h5>
        </div>
        <div class="card-body">
          <div class="row">
            {% for agent in agents %}
            <div class="col-md-6">
              <div class="card agent-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <span>{{ agent.id }}</span>
                  <span class="badge status-{{ agent.status|lower }}">{{ agent.status }}</span>
                </div>
                <div class="card-body">
                  <p><strong>Type:</strong> {{ agent.type }}</p>
                  <div class="d-flex justify-content-between mb-1">
                    <span>Performance:</span>
                    <span>{{ "%.2f"|format(agent.performance.overall * 100) }}%</span>
                  </div>
                  <div class="performance-indicator">
                    <div class="performance-bar" style="width: {{ agent.performance.overall * 100 }}%;"></div>
                  </div>
                  <div class="mt-3">
                    <button class="btn btn-sm btn-primary agent-details-btn" data-agent-id="{{ agent.id }}">Details</button>
                    <button class="btn btn-sm btn-outline-secondary request-help-btn" data-agent-id="{{ agent.id }}">Request Help</button>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Agent Command Structure</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <h6>Hierarchical Command Structure</h6>
            <p class="text-muted">Based on the Strategic Orchestration Guide for BCBS GeoAssessment System</p>
          </div>
          <div id="command-structure-diagram" class="mermaid">
            {{ mermaid_diagram | safe }}
          </div>
        </div>
      </div>
      
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Agent Collaboration Network</h5>
        </div>
        <div class="card-body">
          <div id="communication-graph"></div>
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="card metrics-card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Activity Notifications</h5>
        </div>
        <div class="card-body">
          <div id="activity-feed" class="mb-3">
            <div class="card notification-card mb-2">
              <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-start">
                  <span class="badge bg-success">Initialization</span>
                  <small class="text-muted">just now</small>
                </div>
                <p class="mb-0 mt-1">MCP Army system initialized with hierarchical command structure</p>
              </div>
            </div>
            <div class="card notification-card mb-2">
              <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-start">
                  <span class="badge bg-info">Registration</span>
                  <small class="text-muted">1 min ago</small>
                </div>
                <p class="mb-0 mt-1">Architect Prime agent (workflow_coordinator) registered</p>
              </div>
            </div>
            <div class="card notification-card mb-2">
              <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-start">
                  <span class="badge bg-info">Registration</span>
                  <small class="text-muted">1 min ago</small>
                </div>
                <p class="mb-0 mt-1">Integration Coordinator agent (MCP) registered</p>
              </div>
            </div>
            <div class="card notification-card mb-2">
              <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-start">
                  <span class="badge bg-warning">Broadcast</span>
                  <small class="text-muted">2 mins ago</small>
                </div>
                <p class="mb-0 mt-1">Master prompt broadcast to all agents</p>
              </div>
            </div>
          </div>
          <button class="btn btn-sm btn-outline-primary w-100" id="clear-notifications-btn">Clear All Notifications</button>
        </div>
      </div>
      
      <div class="card metrics-card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Experience Replay</h5>
        </div>
        <div class="card-body">
          <div id="experience-stats">
            <p><strong>Loading experience statistics...</strong></p>
          </div>
          
          <hr>
          
          <h6>Recent Experiences</h6>
          <div class="table-responsive">
            <table class="table table-sm experiences-table">
              <thead>
                <tr>
                  <th>Agent</th>
                  <th>Event Type</th>
                  <th>Time</th>
                </tr>
              </thead>
              <tbody id="recent-experiences">
                <tr>
                  <td colspan="3" class="text-center">Loading experiences...</td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <button class="btn btn-sm btn-primary" id="start-training-btn">Start Training Cycle</button>
        </div>
      </div>
      
      <div class="card metrics-card">
        <div class="card-header">
          <h5 class="mb-0">Collaborative Workflows</h5>
        </div>
        <div class="card-body">
          <div class="list-group">
            <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center workflow-btn" data-workflow="levy_compliance_audit">
              Levy Compliance Audit
              <span class="badge bg-primary">Basic</span>
            </button>
            <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center workflow-btn" data-workflow="cross_district_analysis">
              Cross-District Analysis
              <span class="badge bg-success">Advanced</span>
            </button>
            <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center workflow-btn" data-workflow="historical_trend_forecasting">
              Historical Trend Forecasting
              <span class="badge bg-warning">Complex</span>
            </button>
            <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center workflow-btn" data-workflow="regulatory_compliance_check">
              Regulatory Compliance Check
              <span class="badge bg-info">Standard</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal for Agent Details -->
<div class="modal fade" id="agentDetailsModal" tabindex="-1" role="dialog" aria-labelledby="agentDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="agentDetailsModalLabel">Agent Details</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="agentDetailsContent">
        <p>Loading agent details...</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer" style="z-index: 1500;">
  <!-- Toasts will be dynamically added here -->
</div>

<!-- Modal for Workflow Execution -->
<div class="modal fade" id="workflowModal" tabindex="-1" role="dialog" aria-labelledby="workflowModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="workflowModalLabel">Execute Workflow</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="workflowForm">
          <input type="hidden" id="workflowName" name="workflowName" value="">
          
          <div class="form-group">
            <label for="taxDistrictId">Tax District</label>
            <select class="form-control" id="taxDistrictId" name="taxDistrictId">
              <option value="">Select a district...</option>
              <!-- Districts will be loaded dynamically -->
            </select>
          </div>
          
          <div class="form-group">
            <label for="year">Year</label>
            <select class="form-control" id="year" name="year">
              <option value="2025">2025</option>
              <option value="2024">2024</option>
              <option value="2023">2023</option>
              <option value="2022">2022</option>
              <option value="2021">2021</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="additionalParams">Additional Parameters (JSON)</label>
            <textarea class="form-control" id="additionalParams" name="additionalParams" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="executeWorkflowBtn">Execute</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.2.3/dist/mermaid.min.js"></script>
<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: 'default',
    securityLevel: 'loose',
    flowchart: {
      useMaxWidth: true,
      htmlLabels: true,
      curve: 'basis'
    }
  });
</script>
<script>
  $(document).ready(function() {
    // Toast notification function
    function showToast(title, message, type = 'info', autohide = true, delay = 5000) {
      const toastId = 'toast-' + Date.now();
      const toastTypes = {
        'success': {
          icon: 'check-circle-fill',
          bgClass: 'toast-success'
        },
        'info': {
          icon: 'info-circle-fill',
          bgClass: 'toast-info'
        },
        'warning': {
          icon: 'exclamation-triangle-fill',
          bgClass: 'toast-warning'
        },
        'error': {
          icon: 'x-circle-fill',
          bgClass: 'toast-error'
        }
      };
      
      const typeInfo = toastTypes[type] || toastTypes.info;
      
      const toastHtml = `
        <div class="toast ${typeInfo.bgClass}" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="${autohide}" data-bs-delay="${delay}">
          <div class="toast-header">
            <svg class="bd-placeholder-img me-2" width="20" height="20" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid slice" focusable="false" role="img">
              <rect width="100%" height="100%" fill="currentColor"></rect>
              <text x="50%" y="50%" fill="#fff" text-anchor="middle" dominant-baseline="middle">i</text>
            </svg>
            <strong class="me-auto">${title}</strong>
            <small class="text-muted">just now</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
          <div class="toast-body">
            ${message}
          </div>
        </div>
      `;
      
      // Add toast to container
      $('#toastContainer').append(toastHtml);
      
      // Initialize and show the toast
      const toastElement = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastElement);
      toast.show();
      
      // Remove toast from DOM after it's hidden
      $(toastElement).on('hidden.bs.toast', function() {
        $(this).remove();
      });
      
      return toastId;
    }
    
    // Load experience statistics
    // Function to load command structure info for a specific agent
    function loadAgentCommandInfo(agentId) {
      $.ajax({
        url: '/mcp-army/api/command-structure',
        method: 'GET',
        success: function(data) {
          let role = "Unknown";
          let reports_to = "None";
          let supervises = [];
          
          // Find role in command structure
          if (data.command_structure.architect_prime === agentId) {
            role = "Architect Prime";
          } else if (data.command_structure.integration_coordinator === agentId) {
            role = "Integration Coordinator";
          } else {
            // Check component leads
            for (const [component, leadId] of Object.entries(data.command_structure.component_leads)) {
              if (leadId === agentId) {
                role = `Component Lead (${component})`;
                break;
              }
            }
            
            // Check specialist agents
            if (role === "Unknown") {
              for (const [domain, agents] of Object.entries(data.command_structure.specialist_agents)) {
                if (agents.includes(agentId)) {
                  role = `Specialist Agent (${domain})`;
                  break;
                }
              }
            }
          }
          
          // Get relationship info
          if (data.agent_relationships[agentId]) {
            const relationship = data.agent_relationships[agentId];
            if (relationship.reports_to) {
              reports_to = relationship.reports_to;
            }
            supervises = relationship.supervises || [];
          }
          
          // Build HTML
          let commandHtml = `
            <div class="card mb-3">
              <div class="card-header bg-info text-white">
                <h5 class="mb-0">Command Structure Role</h5>
              </div>
              <div class="card-body">
                <p><strong>Role:</strong> ${role}</p>
                <p><strong>Reports to:</strong> ${reports_to === "None" ? "None (Top Level)" : reports_to}</p>
                <p><strong>Supervises:</strong> ${supervises.length === 0 ? "None" : supervises.join(", ")}</p>
              </div>
            </div>
          `;
          
          $('#agent-command-info').html(commandHtml);
        },
        error: function(err) {
          $('#agent-command-info').html('<p class="text-danger">Error loading command structure information</p>');
          console.error('Error loading command info:', err);
        }
      });
    }
    
    function loadExperienceStats() {
      $.ajax({
        url: '/mcp-army/api/experiences/stats',
        method: 'GET',
        success: function(data) {
          let html = '';
          if (data.total_experiences === 0) {
            html = '<p>No experiences recorded yet.</p>';
          } else {
            html = `
              <p><strong>Total Experiences:</strong> ${data.total_experiences}</p>
              <p><strong>Utilization:</strong> ${(data.utilization * 100).toFixed(2)}%</p>
              <p><strong>Most Recent:</strong> ${new Date(data.most_recent).toLocaleString()}</p>
              
              <h6>By Event Type</h6>
              <ul>
                ${Object.entries(data.by_event_type).map(([type, count]) => 
                  `<li>${type}: ${count}</li>`
                ).join('')}
              </ul>
            `;
          }
          $('#experience-stats').html(html);
        },
        error: function(err) {
          $('#experience-stats').html('<p class="text-danger">Error loading experience statistics</p>');
          console.error('Error loading experience statistics:', err);
        }
      });
    }
    
    // Load recent experiences
    function loadRecentExperiences() {
      // For simplicity, we'll just get experiences from the first agent
      const firstAgentId = '{{ agents[0].id if agents|length > 0 else "" }}';
      if (!firstAgentId) {
        $('#recent-experiences').html('<tr><td colspan="3" class="text-center">No agents available</td></tr>');
        return;
      }
      
      $.ajax({
        url: `/mcp-army/api/agents/${firstAgentId}/experiences?limit=5`,
        method: 'GET',
        success: function(data) {
          if (!data.experiences || data.experiences.length === 0) {
            $('#recent-experiences').html('<tr><td colspan="3" class="text-center">No experiences recorded yet</td></tr>');
            return;
          }
          
          let html = '';
          data.experiences.forEach(exp => {
            html += `
              <tr>
                <td>${exp.agentId}</td>
                <td><span class="badge ${exp.eventType === 'error' ? 'badge-danger' : 'badge-info'}">${exp.eventType}</span></td>
                <td>${new Date(exp.timestamp).toLocaleTimeString()}</td>
              </tr>
            `;
          });
          
          $('#recent-experiences').html(html);
        },
        error: function(err) {
          $('#recent-experiences').html('<tr><td colspan="3" class="text-center text-danger">Error loading experiences</td></tr>');
          console.error('Error loading recent experiences:', err);
        }
      });
    }
    
    // View agent details
    $('.agent-details-btn').click(function() {
      const agentId = $(this).data('agent-id');
      
      $.ajax({
        url: `/mcp-army/api/agents/${agentId}`,
        method: 'GET',
        success: function(data) {
          let html = `
            <h4>${data.agent_id}</h4>
            <div class="row">
              <div class="col-md-6">
                <p><strong>Status:</strong> <span class="badge status-${data.status.status.toLowerCase()}">${data.status.status}</span></p>
                <p><strong>Last Updated:</strong> ${new Date(data.status.last_updated).toLocaleString()}</p>
              </div>
              <div class="col-md-6">
                <h5>Performance Metrics</h5>
                <table class="table table-sm">
                  <tr>
                    <td>Overall Score</td>
                    <td>${(data.status.performance.overall * 100).toFixed(2)}%</td>
                  </tr>
                  <tr>
                    <td>Task Success Rate</td>
                    <td>${(data.status.performance.task_success_rate * 100).toFixed(2)}%</td>
                  </tr>
                  <tr>
                    <td>Average Response Time</td>
                    <td>${data.status.performance.response_time.toFixed(2)}ms</td>
                  </tr>
                  <tr>
                    <td>Error Rate</td>
                    <td>${(data.status.performance.error_rate * 100).toFixed(2)}%</td>
                  </tr>
                </table>
              </div>
            </div>
            
            <div id="agent-command-info">
              <p>Loading command structure information...</p>
            </div>
            
            <h5 class="mt-3">Capabilities</h5>
            <div id="agent-capabilities">
              <p>Loading capabilities...</p>
            </div>
            
            <h5 class="mt-3">Recent Activities</h5>
            <div id="agent-activities">
              <p>Loading activities...</p>
            </div>
          `;
          
          $('#agentDetailsContent').html(html);
          $('#agentDetailsModal').modal('show');
          
          // Load command structure information for this agent
          loadAgentCommandInfo(agentId);
          
          // In a full implementation, we would load capabilities and activities here
        },
        error: function(err) {
          alert('Error loading agent details: ' + err.responseJSON?.error || 'Unknown error');
          console.error('Error loading agent details:', err);
        }
      });
    });
    
    // Request help
    $('.request-help-btn').click(function() {
      const agentId = $(this).data('agent-id');
      
      // Find a suitable agent to provide help (for demo, use workflow coordinator)
      const helperAgent = 'workflow_coordinator';
      
      $.ajax({
        url: `/mcp-army/api/agents/${helperAgent}/assistance/${agentId}`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
          assistance_type: 'performance_improvement'
        }),
        success: function(data) {
          // Add notification to activity feed
          const notification = `
            <div class="card notification-card mb-2">
              <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-start">
                  <span class="badge bg-warning">Assistance</span>
                  <small class="text-muted">just now</small>
                </div>
                <p class="mb-0 mt-1">Agent "${agentId}" requested assistance from "${helperAgent}"</p>
                <small class="text-muted">Task ID: ${data.task_id}</small>
              </div>
            </div>
          `;
          
          $('#activity-feed').prepend(notification);
          $('#clear-notifications-btn').prop('disabled', false);
          
          // Show toast notification instead of alert
          showToast(
            'Help Requested', 
            `Agent ${agentId} requested assistance from ${helperAgent}`,
            'warning'
          );
        },
        error: function(err) {
          const errorMessage = err.responseJSON?.error || 'Unknown error';
          // Show error toast notification
          showToast(
            'Help Request Failed', 
            `Error requesting help: ${errorMessage}`,
            'error',
            true,
            8000
          );
          console.error('Error requesting help:', err);
        }
      });
    });
    
    // Clear notifications
    $('#clear-notifications-btn').click(function() {
      $('#activity-feed').html('<p class="text-center text-muted">No notifications</p>');
      $(this).prop('disabled', true);
      
      // Show toast notification
      showToast(
        'Notifications Cleared', 
        'All notifications have been cleared from the activity feed',
        'secondary',
        true,
        3000
      );
      
      // Add a sample notification about clearing
      setTimeout(() => {
        const notification = `
          <div class="card notification-card mb-2">
            <div class="card-body p-2">
              <div class="d-flex justify-content-between align-items-start">
                <span class="badge bg-secondary">System</span>
                <small class="text-muted">just now</small>
              </div>
              <p class="mb-0 mt-1">Notifications cleared by user</p>
            </div>
          </div>
        `;
        $('#activity-feed').html(notification);
        $(this).prop('disabled', false);
      }, 500);
    });
    
    // Start training cycle
    $('#start-training-btn').click(function() {
      $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Training...');
      
      $.ajax({
        url: '/mcp-army/api/training/start',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ batch_size: 32 }),
        success: function(data) {
          // Add notification to activity feed for training
          const notification = `
            <div class="card notification-card mb-2">
              <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-start">
                  <span class="badge bg-success">Training</span>
                  <small class="text-muted">just now</small>
                </div>
                <p class="mb-0 mt-1">Training cycle completed successfully</p>
                <small class="text-muted">Batch size: ${data.batch_size || 32}, Trained examples: ${data.processed_examples || 'N/A'}</small>
              </div>
            </div>
          `;
          
          $('#activity-feed').prepend(notification);
          $('#clear-notifications-btn').prop('disabled', false);
          
          // Show toast notification instead of alert
          showToast(
            'Training Complete', 
            `Trained ${data.processed_examples || 'N/A'} examples successfully`,
            'info'
          );
          loadExperienceStats();
          loadRecentExperiences();
        },
        error: function(err) {
          const errorMessage = err.responseJSON?.error || 'Unknown error';
          // Show error toast notification
          showToast(
            'Training Error', 
            `Error starting training cycle: ${errorMessage}`,
            'error',
            true,
            8000
          );
          console.error('Error starting training:', err);
        },
        complete: function() {
          $('#start-training-btn').prop('disabled', false).text('Start Training Cycle');
        }
      });
    });
    
    // Execute workflow
    $('.workflow-btn').click(function() {
      const workflowName = $(this).data('workflow');
      $('#workflowName').val(workflowName);
      $('#workflowModalLabel').text(`Execute ${workflowName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}`);
      $('#workflowModal').modal('show');
      
      // For a full implementation, we would load available tax districts here
    });
    
    $('#executeWorkflowBtn').click(function() {
      const workflowName = $('#workflowName').val();
      const taxDistrictId = $('#taxDistrictId').val();
      const year = $('#year').val();
      const additionalParams = $('#additionalParams').val();
      
      if (!taxDistrictId) {
        showToast('Form Error', 'Please select a tax district', 'warning');
        return;
      }
      
      const params = {
        tax_district_id: taxDistrictId,
        year: parseInt(year)
      };
      
      // Parse additional parameters if provided
      if (additionalParams) {
        try {
          const extraParams = JSON.parse(additionalParams);
          Object.assign(params, extraParams);
        } catch (e) {
          showToast('JSON Error', 'Invalid JSON in additional parameters', 'error', true);
          return;
        }
      }
      
      // Execute the workflow
      $.ajax({
        url: '/mcp-army/api/workflows/collaborative',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
          workflow_name: workflowName,
          parameters: params
        }),
        success: function(data) {
          $('#workflowModal').modal('hide');
          
          // Add the notification to the activity feed
          const notification = `
            <div class="card notification-card mb-2">
              <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-start">
                  <span class="badge bg-primary">Workflow</span>
                  <small class="text-muted">just now</small>
                </div>
                <p class="mb-0 mt-1">Started workflow "${workflowName.replace(/_/g, ' ')}" for Tax District ID: ${taxDistrictId}</p>
                <small class="text-muted">Task ID: ${data.task_id || 'N/A'}</small>
              </div>
            </div>
          `;
          
          // Show toast notification
          showToast(
            'Workflow Started', 
            `Started collaboration workflow: ${workflowName.replace(/_/g, ' ')}`,
            'success'
          );
          
          $('#activity-feed').prepend(notification);
          $('#clear-notifications-btn').prop('disabled', false);
        },
        error: function(err) {
          const errorMessage = err.responseJSON?.error || 'Unknown error';
          // Show error toast notification
          showToast(
            'Workflow Error', 
            `Error executing workflow: ${errorMessage}`,
            'error',
            true,
            8000  // Show error for longer time
          );
          console.error('Error executing workflow:', err);
        }
      });
    });
    
    // Initialize
    loadExperienceStats();
    loadRecentExperiences();
    
    // For demo purposes, we'll load a simple communication graph visualization
    // In a full implementation, this would be a more sophisticated D3.js visualization
    $('#communication-graph').html('<div class="text-center p-5"><p>Communication graph visualization would appear here</p><p>This would show interactions between agents over time</p></div>');
  });
</script>
{% endblock %}