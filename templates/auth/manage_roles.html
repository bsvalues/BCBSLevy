{% extends "base.html" %}

{% block title %}Manage User Roles{% endblock %}

{% block page_title %}Manage User Roles{% endblock %}
{% block page_subtitle %}Assign and manage role-based access control{% endblock %}

{% block header_actions %}
<a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary">
  <i class="bi bi-arrow-left me-1"></i> Back to Admin
</a>
{% endblock %}

{% block content %}
<div class="container mb-5">
  <!-- Role Management Overview Card -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="card-title mb-0">
        <i class="bi bi-shield-lock me-2"></i>Role-Based Access Control
      </h5>
    </div>
    <div class="card-body">
      <p class="mb-4">
        Manage user roles for the multi-stage certification workflow. Roles determine which dashboards and features users can access.
      </p>
      
      <div class="row">
        <div class="col-md-4">
          <div class="card h-100 border-start border-primary border-4">
            <div class="card-body">
              <h5 class="card-title"><i class="bi bi-upload text-primary me-2"></i>Clerk</h5>
              <p class="card-text">Responsible for data entry, import, and validation. Prepares data for deputy review.</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card h-100 border-start border-info border-4">
            <div class="card-body">
              <h5 class="card-title"><i class="bi bi-shield-check text-info me-2"></i>Deputy</h5>
              <p class="card-text">Reviews and verifies data accuracy, ensures compliance with regulations and policies.</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card h-100 border-start border-success border-4">
            <div class="card-body">
              <h5 class="card-title"><i class="bi bi-check2-all text-success me-2"></i>Assessor</h5>
              <p class="card-text">Provides final certification and approval. Manages official reports and public communication.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- User Role Assignment Table -->
  <div class="card border-0 shadow-sm">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
      <h5 class="card-title mb-0">
        <i class="bi bi-people me-2"></i>User Role Assignments
      </h5>
      <a href="{{ url_for('auth.register') }}" class="btn btn-sm btn-outline-light">
        <i class="bi bi-person-plus me-1"></i> Add New User
      </a>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Username</th>
              <th>Full Name</th>
              <th>Email</th>
              <th>Admin</th>
              <th>Clerk</th>
              <th>Deputy</th>
              <th>Assessor</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
            <tr>
              <td>{{ user.username }}</td>
              <td>{{ user.full_name }}</td>
              <td>{{ user.email }}</td>
              <td class="text-center">
                {% if user.is_admin %}
                <i class="bi bi-check-circle-fill text-success fs-5"></i>
                {% else %}
                <i class="bi bi-dash-circle text-muted fs-5"></i>
                {% endif %}
              </td>
              <td class="text-center">
                <div class="form-check form-switch d-flex justify-content-center">
                  <input class="form-check-input role-toggle" type="checkbox" 
                         data-user="{{ user.id }}" data-role="clerk"
                         {% if user.has_role('clerk') %}checked{% endif %}
                         {% if current_user.id == user.id %}disabled{% endif %}>
                </div>
              </td>
              <td class="text-center">
                <div class="form-check form-switch d-flex justify-content-center">
                  <input class="form-check-input role-toggle" type="checkbox" 
                         data-user="{{ user.id }}" data-role="deputy"
                         {% if user.has_role('deputy') %}checked{% endif %}
                         {% if current_user.id == user.id %}disabled{% endif %}>
                </div>
              </td>
              <td class="text-center">
                <div class="form-check form-switch d-flex justify-content-center">
                  <input class="form-check-input role-toggle" type="checkbox" 
                         data-user="{{ user.id }}" data-role="assessor"
                         {% if user.has_role('assessor') %}checked{% endif %}
                         {% if current_user.id == user.id %}disabled{% endif %}>
                </div>
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <a href="{{ url_for('auth.edit_user', user_id=user.id) }}" class="btn btn-outline-primary">
                    <i class="bi bi-pencil"></i>
                  </a>
                  {% if current_user.id != user.id %}
                  <button type="button" class="btn btn-outline-danger" 
                          data-bs-toggle="modal" data-bs-target="#deleteUserModal"
                          data-user-id="{{ user.id }}" data-username="{{ user.username }}">
                    <i class="bi bi-trash"></i>
                  </button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
            {% if not users %}
            <tr>
              <td colspan="8" class="text-center py-4">No users found</td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Delete User Confirmation Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteUserModalLabel">Confirm User Deletion</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete the user <strong id="deleteUsername"></strong>?</p>
        <p class="text-danger">This action cannot be undone. All data associated with this user will be permanently deleted.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteUserForm" method="POST" action="">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-danger">Delete User</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Role toggle switch functionality
    document.querySelectorAll('.role-toggle').forEach(toggle => {
      toggle.addEventListener('change', function() {
        const userId = this.dataset.user;
        const role = this.dataset.role;
        const hasRole = this.checked;
        
        // Send AJAX request to update role
        fetch('{{ url_for("auth.update_role") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
          },
          body: JSON.stringify({
            user_id: userId,
            role: role,
            has_role: hasRole
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Show success notification
            const toast = document.createElement('div');
            toast.classList.add('toast', 'show', 'position-fixed', 'bottom-0', 'end-0', 'm-3');
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            toast.innerHTML = `
              <div class="toast-header bg-success text-white">
                <strong class="me-auto">Role Updated</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
              </div>
              <div class="toast-body">
                Successfully ${hasRole ? 'added' : 'removed'} ${role} role ${hasRole ? 'to' : 'from'} user.
              </div>
            `;
            document.body.appendChild(toast);
            
            // Automatically remove toast after 3 seconds
            setTimeout(() => {
              toast.remove();
            }, 3000);
          } else {
            // Show error and reset toggle
            alert(`Error: ${data.message}`);
            this.checked = !this.checked;
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while updating the role.');
          this.checked = !this.checked;
        });
      });
    });
    
    // Delete user modal functionality
    const deleteUserModal = document.getElementById('deleteUserModal');
    if (deleteUserModal) {
      deleteUserModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const userId = button.getAttribute('data-user-id');
        const username = button.getAttribute('data-username');
        
        document.getElementById('deleteUsername').textContent = username;
        document.getElementById('deleteUserForm').action = `{{ url_for('auth.delete_user', user_id=0) }}`.replace('0', userId);
      });
    }
  });
</script>
{% endblock %}