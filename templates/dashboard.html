{% extends "terralevy-base.html" %}

{% block title %}TerraLevy Dashboard{% endblock %}

{% block page_title %}TerraLevy Dashboard{% endblock %}

{% block page_subtitle %}Welcome to your comprehensive levy management hub{% endblock %}

{% block page_actions %}
<div class="d-flex justify-content-end gap-2 mt-3">
  <button type="button" class="btn tl-btn-outline" id="refreshDashboard">
    <i class="bi bi-arrow-clockwise me-1"></i> Refresh
  </button>
  <button type="button" class="btn tl-btn-primary" data-bs-toggle="modal" data-bs-target="#quickActionModal">
    <i class="bi bi-lightning-charge me-1"></i> Quick Actions
  </button>
</div>
{% endblock %}

{% block content %}
<!-- Quick Stats Row -->
<div class="row mb-4">
  <div class="col-md-3 mb-3 mb-md-0">
    <div class="tl-card tl-dashboard-card">
      <div class="d-flex align-items-center mb-3">
        <div class="rounded-circle p-3 tl-bg-primary me-3">
          <i class="bi bi-calculator text-dark fs-4"></i>
        </div>
        <div>
          <span class="text-muted fs-6">Active Tax Districts</span>
          <h3 class="tl-dashboard-stat mb-0">{{ stats.districts|default(42) }}</h3>
        </div>
      </div>
      <div class="progress" style="height: 5px;">
        <div class="progress-bar tl-bg-primary" role="progressbar" style="width: 85%;" aria-valuenow="85" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
      <p class="text-end mt-2 mb-0"><small class="text-muted">Updated today</small></p>
    </div>
  </div>
  
  <div class="col-md-3 mb-3 mb-md-0">
    <div class="tl-card tl-dashboard-card">
      <div class="d-flex align-items-center mb-3">
        <div class="rounded-circle p-3 bg-success me-3">
          <i class="bi bi-check-circle text-white fs-4"></i>
        </div>
        <div>
          <span class="text-muted fs-6">Compliance Rate</span>
          <h3 class="tl-dashboard-stat mb-0">{{ stats.compliance_rate|default('92.8%') }}</h3>
        </div>
      </div>
      <div class="progress" style="height: 5px;">
        <div class="progress-bar bg-success" role="progressbar" style="width: 92.8%;" aria-valuenow="92.8" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
      <p class="text-end mt-2 mb-0"><small class="text-muted">5% increase since last month</small></p>
    </div>
  </div>
  
  <div class="col-md-3 mb-3 mb-md-0">
    <div class="tl-card tl-dashboard-card">
      <div class="d-flex align-items-center mb-3">
        <div class="rounded-circle p-3 bg-info me-3">
          <i class="bi bi-graph-up text-white fs-4"></i>
        </div>
        <div>
          <span class="text-muted fs-6">Total AV (billions)</span>
          <h3 class="tl-dashboard-stat mb-0">{{ stats.total_av|default('$5.3B') }}</h3>
        </div>
      </div>
      <div class="progress" style="height: 5px;">
        <div class="progress-bar bg-info" role="progressbar" style="width: 75%;" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
      <p class="text-end mt-2 mb-0"><small class="text-muted">7.2% YoY growth</small></p>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="tl-card tl-dashboard-card">
      <div class="d-flex align-items-center mb-3">
        <div class="rounded-circle p-3 bg-warning me-3">
          <i class="bi bi-exclamation-triangle text-dark fs-4"></i>
        </div>
        <div>
          <span class="text-muted fs-6">Pending Actions</span>
          <h3 class="tl-dashboard-stat mb-0">{{ stats.pending_actions|default(7) }}</h3>
        </div>
      </div>
      <div class="progress" style="height: 5px;">
        <div class="progress-bar bg-warning" role="progressbar" style="width: 35%;" aria-valuenow="35" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
      <p class="text-end mt-2 mb-0"><small class="text-muted">Review required</small></p>
    </div>
  </div>
</div>

<!-- Main Content Row -->
<div class="row">
  <!-- Tax Districts Performance -->
  <div class="col-lg-8 mb-4">
    <div class="tl-card h-100">
      <div class="tl-card-header">
        <h2 class="tl-card-title">Tax District Performance</h2>
        <div class="dropdown">
          <button class="btn btn-sm tl-btn-outline dropdown-toggle" type="button" id="districtPerformanceOptions" data-bs-toggle="dropdown" aria-expanded="false">
            Last 30 Days
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="districtPerformanceOptions">
            <li><a class="dropdown-item" href="#">Last 7 Days</a></li>
            <li><a class="dropdown-item active" href="#">Last 30 Days</a></li>
            <li><a class="dropdown-item" href="#">Last Quarter</a></li>
            <li><a class="dropdown-item" href="#">Year to Date</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#">Custom Range...</a></li>
          </ul>
        </div>
      </div>
      <div class="card-body">
        <div class="chart-container" style="position: relative; height: 300px;">
          <canvas id="districtPerformanceChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Recent Activity -->
  <div class="col-lg-4 mb-4">
    <div class="tl-card h-100">
      <div class="tl-card-header">
        <h2 class="tl-card-title">Recent Activity</h2>
        <a href="/activity-log" class="btn btn-sm tl-btn-outline">View All</a>
      </div>
      <div class="card-body p-0">
        <div class="list-group list-group-flush">
          <a href="#" class="list-group-item list-group-item-action py-3">
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1">Levy Calculation Updated</h6>
              <small class="text-muted">3 mins ago</small>
            </div>
            <p class="mb-1 text-muted">School District #123 levy rate updated to 2.5498.</p>
            <small><i class="bi bi-person-circle me-1"></i> By: John Smith</small>
          </a>
          <a href="#" class="list-group-item list-group-item-action py-3">
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1">New Scenario Created</h6>
              <small class="text-muted">2 hours ago</small>
            </div>
            <p class="mb-1 text-muted">City of Springfield 2025 Forecast created.</p>
            <small><i class="bi bi-person-circle me-1"></i> By: Jane Doe</small>
          </a>
          <a href="#" class="list-group-item list-group-item-action py-3">
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1">Compliance Alert Resolved</h6>
              <small class="text-muted">Yesterday</small>
            </div>
            <p class="mb-1 text-muted">Fire District #7 compliance issue resolved.</p>
            <small><i class="bi bi-person-circle me-1"></i> By: Robert Johnson</small>
          </a>
          <a href="#" class="list-group-item list-group-item-action py-3">
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1">Data Import Completed</h6>
              <small class="text-muted">2 days ago</small>
            </div>
            <p class="mb-1 text-muted">2025 assessment values imported successfully.</p>
            <small><i class="bi bi-person-circle me-1"></i> By: System</small>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Compliance Issues -->
  <div class="col-lg-4 mb-4">
    <div class="tl-card h-100">
      <div class="tl-card-header">
        <h2 class="tl-card-title">Compliance Issues</h2>
        <a href="/compliance-dashboard" class="btn btn-sm tl-btn-outline">View All</a>
      </div>
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-4">
          <div class="d-flex align-items-center">
            <div class="rounded-circle p-2 bg-danger me-2">
              <i class="bi bi-exclamation-circle text-white"></i>
            </div>
            <span>Critical Issues</span>
          </div>
          <span class="badge bg-danger">2</span>
        </div>
        
        <div class="d-flex align-items-center justify-content-between mb-4">
          <div class="d-flex align-items-center">
            <div class="rounded-circle p-2 bg-warning me-2">
              <i class="bi bi-exclamation-triangle text-dark"></i>
            </div>
            <span>Warning Issues</span>
          </div>
          <span class="badge bg-warning text-dark">5</span>
        </div>
        
        <div class="d-flex align-items-center justify-content-between mb-4">
          <div class="d-flex align-items-center">
            <div class="rounded-circle p-2 bg-success me-2">
              <i class="bi bi-check-circle text-white"></i>
            </div>
            <span>Resolved This Month</span>
          </div>
          <span class="badge bg-success">12</span>
        </div>
        
        <div class="alert tl-alert-warning mt-3">
          <i class="bi bi-info-circle me-2"></i>
          <strong>Attention Required:</strong> 2 districts have levy rates exceeding statutory limits.
          <a href="/compliance-dashboard" class="alert-link">Review now</a>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Quick Tasks -->
  <div class="col-lg-4 mb-4">
    <div class="tl-card h-100">
      <div class="tl-card-header">
        <h2 class="tl-card-title">Quick Tasks</h2>
      </div>
      <div class="card-body">
        <div class="list-group">
          <a href="/levy-calculator" class="list-group-item list-group-item-action d-flex align-items-center py-3">
            <i class="bi bi-calculator fs-4 me-3 tl-text-primary"></i>
            <div>
              <h6 class="mb-0">Calculate Levy Rate</h6>
              <small class="text-muted">Determine levy rates based on assessed values</small>
            </div>
          </a>
          <a href="/data-management/import" class="list-group-item list-group-item-action d-flex align-items-center py-3">
            <i class="bi bi-cloud-upload fs-4 me-3 tl-text-primary"></i>
            <div>
              <h6 class="mb-0">Import Data</h6>
              <small class="text-muted">Upload new assessment data or tax codes</small>
            </div>
          </a>
          <a href="/reports/generate" class="list-group-item list-group-item-action d-flex align-items-center py-3">
            <i class="bi bi-file-earmark-text fs-4 me-3 tl-text-primary"></i>
            <div>
              <h6 class="mb-0">Generate Reports</h6>
              <small class="text-muted">Create customized levy reports</small>
            </div>
          </a>
          <a href="/forecasting" class="list-group-item list-group-item-action d-flex align-items-center py-3">
            <i class="bi bi-graph-up-arrow fs-4 me-3 tl-text-primary"></i>
            <div>
              <h6 class="mb-0">Run Forecasts</h6>
              <small class="text-muted">Project future levy scenarios</small>
            </div>
          </a>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Recent Scenarios -->
  <div class="col-lg-4 mb-4">
    <div class="tl-card h-100">
      <div class="tl-card-header">
        <h2 class="tl-card-title">Recent Scenarios</h2>
        <a href="/levy-calculator/scenarios" class="btn btn-sm tl-btn-outline">View All</a>
      </div>
      <div class="card-body p-0">
        <div class="list-group list-group-flush">
          {% for scenario in recent_scenarios|default([
            {'name': 'School District #123 - 2025', 'date': '04/20/2025', 'district': 'School District #123', 'levy_rate': 2.5498},
            {'name': 'City of Springfield - Forecast', 'date': '04/18/2025', 'district': 'City of Springfield', 'levy_rate': 1.8735},
            {'name': 'Fire District #7 - Final', 'date': '04/15/2025', 'district': 'Fire District #7', 'levy_rate': 0.9432}
          ]) %}
          <a href="/levy-calculator/scenarios/{{ loop.index }}" class="list-group-item list-group-item-action py-3">
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1">{{ scenario.name }}</h6>
              <small class="tl-badge tl-badge-primary">{{ scenario.levy_rate }}</small>
            </div>
            <p class="mb-1"><small class="text-muted">{{ scenario.district }}</small></p>
            <small class="text-muted"><i class="bi bi-calendar3 me-1"></i> Created: {{ scenario.date }}</small>
          </a>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quick Action Modal -->
<div class="modal fade" id="quickActionModal" tabindex="-1" aria-labelledby="quickActionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="quickActionModalLabel">Quick Actions</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-grid gap-3">
          <a href="/levy-calculator" class="btn tl-btn-primary d-flex align-items-center p-3">
            <i class="bi bi-calculator fs-3 me-3"></i>
            <div class="text-start">
              <h5 class="mb-0">New Levy Calculation</h5>
              <p class="mb-0 text-muted">Calculate levy rates for a district</p>
            </div>
          </a>
          
          <a href="/data-management/import" class="btn tl-btn-outline d-flex align-items-center p-3">
            <i class="bi bi-cloud-upload fs-3 me-3"></i>
            <div class="text-start">
              <h5 class="mb-0">Import New Data</h5>
              <p class="mb-0 text-muted">Upload assessment values or tax codes</p>
            </div>
          </a>
          
          <a href="/reports/compliance" class="btn tl-btn-outline d-flex align-items-center p-3">
            <i class="bi bi-clipboard-check fs-3 me-3"></i>
            <div class="text-start">
              <h5 class="mb-0">Compliance Check</h5>
              <p class="mb-0 text-muted">Verify district compliance with regulations</p>
            </div>
          </a>
          
          <a href="/reports/export" class="btn tl-btn-outline d-flex align-items-center p-3">
            <i class="bi bi-file-earmark-arrow-down fs-3 me-3"></i>
            <div class="text-start">
              <h5 class="mb-0">Export Reports</h5>
              <p class="mb-0 text-muted">Generate and download reports</p>
            </div>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize performance chart
  const ctx = document.getElementById('districtPerformanceChart').getContext('2d');
  
  const districtPerformanceChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
      datasets: [
        {
          label: 'Actual Levy',
          data: [98, 85, 90, 81, 87, 95, 91, 84, 89, 92, 88, 93],
          borderColor: '#00e5ff',
          backgroundColor: 'rgba(0, 229, 255, 0.1)',
          borderWidth: 2,
          tension: 0.4,
          fill: true
        },
        {
          label: 'Projected Levy',
          data: [95, 88, 84, 85, 90, 93, 88, 87, 90, 93, 95, 97],
          borderColor: '#004d7a',
          backgroundColor: 'rgba(0, 77, 122, 0.05)',
          borderWidth: 2,
          borderDash: [5, 5],
          tension: 0.4,
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top',
          align: 'end'
        },
        tooltip: {
          mode: 'index',
          intersect: false
        }
      },
      scales: {
        y: {
          beginAtZero: false,
          min: 80,
          grid: {
            drawBorder: false
          }
        },
        x: {
          grid: {
            display: false
          }
        }
      }
    }
  });
  
  // Refresh button functionality
  const refreshButton = document.getElementById('refreshDashboard');
  if (refreshButton) {
    refreshButton.addEventListener('click', function() {
      refreshButton.disabled = true;
      refreshButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Refreshing...';
      
      // Simulate refresh (would be an actual API call in production)
      setTimeout(() => {
        // Update chart with new random data
        districtPerformanceChart.data.datasets.forEach((dataset) => {
          dataset.data = dataset.data.map(() => Math.floor(Math.random() * 20) + 80);
        });
        districtPerformanceChart.update();
        
        // Re-enable button
        refreshButton.disabled = false;
        refreshButton.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i> Refresh';
        
        // Show notification
        TerraLevy.showNotification('Dashboard refreshed successfully!', 'success');
      }, 1500);
    });
  }
});
</script>
{% endblock %}