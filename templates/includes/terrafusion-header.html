<header class="tf-navbar-container">
  <div class="container">
    <nav class="navbar navbar-expand-lg tf-navbar">
      <!-- Brand Logo -->
      <a class="navbar-brand" href="{{ url_for('home.index') }}">
        <img src="{{ url_for('static', filename='images/terralevy-logo.svg') }}" alt="TerraFusion Platform" height="30">
        <span class="ms-2 d-none d-sm-inline-block">TerraFusion Platform</span>
      </a>
      
      <!-- Navbar Items - Desktop view -->
      <ul class="navbar-nav d-none d-lg-flex ms-auto me-3">
        <li>
          <a href="{{ url_for('home.dashboard') }}" class="tf-navbar-item {% if request.path == '/dashboard' %}active{% endif %}">
            <i class="bi bi-speedometer2 me-1"></i> Dashboard
          </a>
        </li>
        
        <li class="dropdown">
          <a class="tf-navbar-item dropdown-toggle {% if request.path.startswith('/levy') %}active{% endif %}" 
             href="#" id="taxCalcDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-calculator me-1"></i> Tax Calculation
          </a>
          <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="taxCalcDropdown">
            <li><a class="dropdown-item" href="{{ url_for('levy_calculator.calculator') }}">Levy Calculator</a></li>
            <li><a class="dropdown-item" href="{{ url_for('levy_calculator.get_scenarios') }}">Levy Scenarios</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{{ url_for('levy_calculator.impact_calculator') }}">Tax Impact Analysis</a></li>
            <li><a class="dropdown-item" href="{{ url_for('forecasting.ai_dashboard') }}">Forecasting</a></li>
          </ul>
        </li>
        
        <li class="dropdown">
          <a class="tf-navbar-item dropdown-toggle {% if request.path.startswith('/assessment') %}active{% endif %}" 
             href="#" id="assessmentDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-building me-1"></i> Property Assessment
          </a>
          <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="assessmentDropdown">
            <li><a class="dropdown-item" href="{{ url_for('property_assessment.assessment_dashboard') }}">Assessment Dashboard</a></li>
            <li><a class="dropdown-item" href="{{ url_for('property_assessment.property_valuation') }}">Property Search</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{{ url_for('property_assessment.assessment_workflow') }}">Assessment Workflow</a></li>
            <li><a class="dropdown-item" href="{{ url_for('property_assessment.assessment_dashboard') }}">Compliance Review</a></li>
          </ul>
        </li>
        
        <li class="dropdown">
          <a class="tf-navbar-item dropdown-toggle {% if request.path.startswith('/data') %}active{% endif %}" 
             href="#" id="dataManagementDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-database me-1"></i> Data Management
          </a>
          <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="dataManagementDropdown">
            <li><a class="dropdown-item" href="{{ url_for('data_management.import_data') }}">Import Data</a></li>
            <li><a class="dropdown-item" href="{{ url_for('data_management.export_dashboard') }}">Export Data</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{{ url_for('data_management.quality_dashboard') }}">Data Quality</a></li>
            <li><a class="dropdown-item" href="{{ url_for('data_management.history') }}">Import History</a></li>
          </ul>
        </li>
        
        <li class="dropdown">
          <a class="tf-navbar-item dropdown-toggle {% if request.path.startswith('/reports') %}active{% endif %}" 
             href="#" id="reportsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-file-earmark-text me-1"></i> Reports
          </a>
          <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="reportsDropdown">
            <li><a class="dropdown-item" href="{{ url_for('reports.reports_dashboard') }}">Reports Dashboard</a></li>
            <li><a class="dropdown-item" href="{{ url_for('reports.generate_report') }}">Generate Report</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{{ url_for('reports.templates') }}">Report Templates</a></li>
            <li><a class="dropdown-item" href="{{ url_for('reports.scheduled_reports') }}">Scheduled Reports</a></li>
          </ul>
        </li>
        
        <li>
          <a href="{{ url_for('mcp.mcp_dashboard') }}" class="tf-navbar-item {% if request.path.startswith('/mcp') %}active{% endif %}">
            <i class="bi bi-lightning me-1"></i> Advanced Analysis
          </a>
        </li>
      </ul>
    </nav>

    <!-- Action Buttons -->
    <div class="d-flex align-items-center">
      <!-- Current Workflow Status (if applicable) -->
      {% if active_workflow %}
      <div class="tf-workflow-status d-none d-xl-flex me-3">
        <span class="tf-badge tf-badge-primary">{{ active_workflow }}</span>
        <small class="text-light ms-2">{{ workflow_step|default('') }}</small>
      </div>
      {% endif %}
      
      <!-- Notifications -->
      <div class="dropdown me-2">
        <button class="tf-navbar-item dropdown-toggle position-relative" type="button" id="notificationDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-bell"></i>
          {% if notification_count and notification_count > 0 %}
          <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
            {{ notification_count if notification_count < 100 else '99+' }}
          </span>
          {% endif %}
        </button>
        <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end" aria-labelledby="notificationDropdown">
          <li><h6 class="dropdown-header">Notifications</h6></li>
          {% if notifications %}
            {% for notification in notifications %}
            <li>
              <a class="dropdown-item" href="{{ notification.link|default('#') }}">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0">
                    <i class="bi {{ notification.icon|default('bi-info-circle') }} me-2"></i>
                  </div>
                  <div class="flex-grow-1 ms-2">
                    <p class="mb-0">{{ notification.message }}</p>
                    <small class="text-muted">{{ notification.time }}</small>
                  </div>
                </div>
              </a>
            </li>
            {% endfor %}
          {% else %}
            <li><span class="dropdown-item-text">No new notifications</span></li>
          {% endif %}
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item text-center" href="{{ url_for('notifications.view_all') }}">View all</a></li>
        </ul>
      </div>
      
      <!-- Help Menu -->
      <div class="dropdown me-2">
        <button class="tf-navbar-item dropdown-toggle" type="button" id="helpDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-question-circle"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end" aria-labelledby="helpDropdown">
          <li><a class="dropdown-item" href="{{ url_for('home.help_page') }}"><i class="bi bi-book me-2"></i> User Guide</a></li>
          <li><a class="dropdown-item" href="{{ url_for('glossary.glossary') }}"><i class="bi bi-card-list me-2"></i> Glossary</a></li>
          <li><a class="dropdown-item" href="{{ url_for('home.about') }}"><i class="bi bi-info-circle me-2"></i> About</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="#" id="startTour"><i class="bi bi-signpost me-2"></i> Interactive Tour</a></li>
          <li><a class="dropdown-item" href="#" id="showContextHelp"><i class="bi bi-lightbulb me-2"></i> Context Help</a></li>
        </ul>
      </div>
      
      <!-- User Menu -->
      <div class="dropdown">
        <button class="tf-navbar-item dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-person-circle"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end" aria-labelledby="userDropdown">
          <li>
            <div class="dropdown-item-text">
              <div class="d-flex align-items-center">
                <div class="flex-shrink-0">
                  <i class="bi bi-person-circle fs-4 me-2"></i>
                </div>
                <div class="flex-grow-1 ms-2">
                  <p class="mb-0">{{ current_user.username|default('User') }}</p>
                  <small class="text-muted">{{ current_user.email|default('') }}</small>
                </div>
              </div>
            </div>
          </li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="{{ url_for('user.profile') }}"><i class="bi bi-person me-2"></i> My Profile</a></li>
          <li><a class="dropdown-item" href="{{ url_for('home.settings') }}"><i class="bi bi-gear me-2"></i> Settings</a></li>
          {% if current_user.is_admin %}
          <li><a class="dropdown-item" href="{{ url_for('admin.dashboard') }}"><i class="bi bi-shield-lock me-2"></i> Admin</a></li>
          {% endif %}
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}"><i class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
        </ul>
      </div>
      
      <!-- Mobile Menu Toggle -->
      <button class="tf-navbar-item d-lg-none ms-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileNav" aria-controls="mobileNav">
        <i class="bi bi-list fs-4"></i>
      </button>
    </div>
  </div>
</header>

<!-- Mobile Navigation Offcanvas -->
<div class="offcanvas offcanvas-start bg-dark text-light" tabindex="-1" id="mobileNav" aria-labelledby="mobileNavLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="mobileNavLabel">
      <img src="{{ url_for('static', filename='images/terralevy-logo.svg') }}" alt="TerraFusion Platform" height="30">
      <span class="ms-2">TerraFusion Platform</span>
    </h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body p-0">
    <div class="list-group list-group-flush border-0">
      <a href="{{ url_for('home.dashboard') }}" class="list-group-item list-group-item-action bg-dark text-light border-light border-opacity-10 {% if request.path == '/dashboard' %}active{% endif %}">
        <i class="bi bi-speedometer2 me-2"></i> Dashboard
      </a>
      
      <!-- Tax Calculation Section -->
      <div class="list-group-item bg-dark text-light border-light border-opacity-10">
        <a class="d-flex justify-content-between align-items-center text-decoration-none text-light" data-bs-toggle="collapse" href="#taxCalcCollapse">
          <span><i class="bi bi-calculator me-2"></i> Tax Calculation</span>
          <i class="bi bi-chevron-down"></i>
        </a>
        <div class="collapse mt-2" id="taxCalcCollapse">
          <div class="list-group list-group-flush border-0">
            <a href="{{ url_for('levy_calculator.calculator') }}" class="list-group-item list-group-item-action bg-dark text-light border-light border-opacity-10 ps-4">
              Levy Calculator
            </a>
            <a href="{{ url_for('levy_calculator.get_scenarios') }}" class="list-group-item list-group-item-action bg-dark text-light border-light border-opacity-10 ps-4">
              Levy Scenarios
            </a>
            <a href="{{ url_for('levy_calculator.impact_calculator') }}" class="list-group-item list-group-item-action bg-dark text-light border-light border-opacity-10 ps-4">
              Tax Impact Analysis
            </a>
            <a href="{{ url_for('forecasting.ai_dashboard') }}" class="list-group-item list-group-item-action bg-dark text-light border-light border-opacity-10 ps-4">
              Forecasting
            </a>
          </div>
        </div>
      </div>
      
      <!-- Property Assessment Section -->
      <div class="list-group-item bg-dark text-light border-light border-opacity-10">
        <a class="d-flex justify-content-between align-items-center text-decoration-none text-light" data-bs-toggle="collapse" href="#assessmentCollapse">
          <span><i class="bi bi-building me-2"></i> Property Assessment</span>
          <i class="bi bi-chevron-down"></i>
        </a>
        <div class="collapse mt-2" id="assessmentCollapse">
          <div class="list-group list-group-flush border-0">
            <a href="{{ url_for('property_assessment.assessment_dashboard') }}" class="list-group-item list-group-item-action bg-dark text-light border-light border-opacity-10 ps-4">
              Assessment Dashboard
            </a>
            <a href="{{ url_for('property_assessment.property_valuation') }}" class="list-group-item list-group-item-action bg-dark text-light border-light border-opacity-10 ps-4">
              Property Search
            </a>
            <a href="{{ url_for('property_assessment.assessment_workflow') }}" class="list-group-item list-group-item-action bg-dark text-light border-light border-opacity-10 ps-4">
              Assessment Workflow
            </a>
            <a href="{{ url_for('property_assessment.assessment_dashboard') }}" class="list-group-item list-group-item-action bg-dark text-light border-light border-opacity-10 ps-4">
              Compliance Review
            </a>
          </div>
        </div>
      </div>
      
      <!-- Data Management Section -->
      <div class="list-group-item bg-dark text-light border-light border-opacity-10">
        <a class="d-flex justify-content-between align-items-center text-decoration-none text-light" data-bs-toggle="collapse" href="#dataCollapse">
          <span><i class="bi bi-database me-2"></i> Data Management</span>
          <i class="bi bi-chevron-down"></i>
        </a>
        <div class="collapse mt-2" id="dataCollapse">
          <div class="list-group list-group-flush border-0">
            <a href="{{ url_for('data_management.import_data') }}" class="list-group-item list-group-item-action bg-dark text-light border-light border-opacity-10 ps-4">
              Import Data
            </a>
            <a href="{{ url_for('data_management.export_dashboard') }}" class="list-group-item list-group-item-action bg-dark text-light border-light border-opacity-10 ps-4">
              Export Data
            </a>
            <a href="{{ url_for('data_management.quality_dashboard') }}" class="list-group-item list-group-item-action bg-dark text-light border-light border-opacity-10 ps-4">
              Data Quality
            </a>
            <a href="{{ url_for('data_management.history') }}" class="list-group-item list-group-item-action bg-dark text-light border-light border-opacity-10 ps-4">
              Import History
            </a>
          </div>
        </div>
      </div>
      
      <!-- Reports Section -->
      <div class="list-group-item bg-dark text-light border-light border-opacity-10">
        <a class="d-flex justify-content-between align-items-center text-decoration-none text-light" data-bs-toggle="collapse" href="#reportsCollapse">
          <span><i class="bi bi-file-earmark-text me-2"></i> Reports</span>
          <i class="bi bi-chevron-down"></i>
        </a>
        <div class="collapse mt-2" id="reportsCollapse">
          <div class="list-group list-group-flush border-0">
            <a href="{{ url_for('reports.reports_dashboard') }}" class="list-group-item list-group-item-action bg-dark text-light border-light border-opacity-10 ps-4">
              Reports Dashboard
            </a>
            <a href="{{ url_for('reports.generate_report') }}" class="list-group-item list-group-item-action bg-dark text-light border-light border-opacity-10 ps-4">
              Generate Report
            </a>
            <a href="{{ url_for('reports.templates') }}" class="list-group-item list-group-item-action bg-dark text-light border-light border-opacity-10 ps-4">
              Report Templates
            </a>
            <a href="{{ url_for('reports.scheduled_reports') }}" class="list-group-item list-group-item-action bg-dark text-light border-light border-opacity-10 ps-4">
              Scheduled Reports
            </a>
          </div>
        </div>
      </div>
      
      <a href="{{ url_for('mcp.mcp_dashboard') }}" class="list-group-item list-group-item-action bg-dark text-light border-light border-opacity-10 {% if request.path.startswith('/mcp') %}active{% endif %}">
        <i class="bi bi-lightning me-2"></i> Advanced Analysis
      </a>
      
      <div class="list-group-item bg-dark text-light border-light border-opacity-10">
        <a class="d-flex justify-content-between align-items-center text-decoration-none text-light" data-bs-toggle="collapse" href="#helpCollapse">
          <span><i class="bi bi-question-circle me-2"></i> Help & Support</span>
          <i class="bi bi-chevron-down"></i>
        </a>
        <div class="collapse mt-2" id="helpCollapse">
          <div class="list-group list-group-flush border-0">
            <a href="{{ url_for('home.help_page') }}" class="list-group-item list-group-item-action bg-dark text-light border-light border-opacity-10 ps-4">
              <i class="bi bi-book me-2"></i> User Guide
            </a>
            <a href="{{ url_for('glossary.glossary') }}" class="list-group-item list-group-item-action bg-dark text-light border-light border-opacity-10 ps-4">
              <i class="bi bi-card-list me-2"></i> Glossary
            </a>
            <a href="{{ url_for('home.about') }}" class="list-group-item list-group-item-action bg-dark text-light border-light border-opacity-10 ps-4">
              <i class="bi bi-info-circle me-2"></i> About
            </a>
            <a href="#" id="mobileTour" class="list-group-item list-group-item-action bg-dark text-light border-light border-opacity-10 ps-4">
              <i class="bi bi-signpost me-2"></i> Interactive Tour
            </a>
          </div>
        </div>
      </div>
      
      <hr class="text-light opacity-10 my-2">
      
      <a href="{{ url_for('user.profile') }}" class="list-group-item list-group-item-action bg-dark text-light border-light border-opacity-10">
        <i class="bi bi-person me-2"></i> My Profile
      </a>
      <a href="{{ url_for('home.settings') }}" class="list-group-item list-group-item-action bg-dark text-light border-light border-opacity-10">
        <i class="bi bi-gear me-2"></i> Settings
      </a>
      {% if current_user.is_admin %}
      <a href="{{ url_for('admin.dashboard') }}" class="list-group-item list-group-item-action bg-dark text-light border-light border-opacity-10">
        <i class="bi bi-shield-lock me-2"></i> Admin
      </a>
      {% endif %}
      <a href="{{ url_for('auth.logout') }}" class="list-group-item list-group-item-action bg-dark text-light border-light border-opacity-10">
        <i class="bi bi-box-arrow-right me-2"></i> Logout
      </a>
    </div>
  </div>
</div>

<!-- Breadcrumb (if enabled) -->
{% if show_breadcrumb|default(true) %}
<div class="tf-breadcrumb-container bg-light shadow-sm">
  <div class="container">
    <nav class="tf-breadcrumb" aria-label="breadcrumb">
      <div class="tf-breadcrumb-item">
        <a href="{{ url_for('home.index') }}"><i class="bi bi-house-door"></i> Home</a>
      </div>
      
      {% if breadcrumbs %}
        {% for title, url in breadcrumbs %}
          {% if loop.last %}
            <div class="tf-breadcrumb-item active">{{ title }}</div>
          {% else %}
            <div class="tf-breadcrumb-item">
              <a href="{{ url }}">{{ title }}</a>
            </div>
          {% endif %}
        {% endfor %}
      {% else %}
        {% if request.path != '/' %}
          <div class="tf-breadcrumb-item active">{{ active_page|default('Current Page') }}</div>
        {% endif %}
      {% endif %}
      
      <!-- Workflow Context (if applicable) -->
      {% if workflow_context %}
        <div class="ms-auto tf-workflow-context">
          <span class="tf-badge tf-badge-primary">{{ workflow_context }}</span>
        </div>
      {% endif %}
    </nav>
  </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize tour buttons
  const startTourBtn = document.getElementById('startTour');
  if (startTourBtn) {
    startTourBtn.addEventListener('click', function(e) {
      e.preventDefault();
      if (typeof initGuidedTour === 'function') {
        initGuidedTour();
      }
    });
  }
  
  const mobileTourBtn = document.getElementById('mobileTour');
  if (mobileTourBtn) {
    mobileTourBtn.addEventListener('click', function(e) {
      e.preventDefault();
      // Close the mobile nav
      const bsOffcanvas = bootstrap.Offcanvas.getInstance('#mobileNav');
      if (bsOffcanvas) {
        bsOffcanvas.hide();
      }
      
      // Start tour after a short delay to let offcanvas close
      setTimeout(function() {
        if (typeof initGuidedTour === 'function') {
          initGuidedTour();
        }
      }, 300);
    });
  }
  
  // Context help button
  const showContextHelpBtn = document.getElementById('showContextHelp');
  if (showContextHelpBtn) {
    showContextHelpBtn.addEventListener('click', function(e) {
      e.preventDefault();
      // Toggle context help mode
      document.body.classList.toggle('show-context-help');
      
      // Show toast notification
      const helpModeActive = document.body.classList.contains('show-context-help');
      if (typeof showNotification === 'function') {
        if (helpModeActive) {
          showNotification('Context Help Mode', 'Click on any element with a ? icon to see help information.', 'info');
        } else {
          showNotification('Context Help Mode Disabled', 'Context help mode has been turned off.', 'info');
        }
      }
    });
  }
});
</script>